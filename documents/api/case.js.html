<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: case.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: case.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import {
    View
} from "./view"
import {
    Model
} from "./model/model"
import {
    Controller
} from "./controller"
import {
    Getter
} from "./getter"
import {
    Cassette,
    CloseCassette,
    ImportDataFromDataSet
} from "./cassette/cassette"
import {
    Form
} from "./cassette/form"
import {
    Input
} from "./cassette/input"
import {
    Exporter
} from "./cassette/exporter"
import {
    ImportQuery
} from "./cassette/import_query"
import {
    EpochToDateTime
} from "./cassette/epoch_to_dt"

let PresetCassettes = {
    raw: Cassette,
    cassette: Cassette,
    form: Form,
    input: Input,
    export: Exporter,
    iquery: ImportQuery,
    edt:EpochToDateTime
}

class CaseParentView extends View {
    constructor(Case) {
        super();
        this.case = Case;
    }

    destructor() {
        if (this.case)
            this.case.destructor();
        super.destructor();
    }

    update(data) {
        if (this.case)
            this.case.updateFromParent(data);
    }

    updateDimensions() {
        if (this.case)
            this.case.updateDimensions();
    }
}

class Case extends View {
    /**
        Case constructor. Builds a Case object.
        @params [DOMElement] element - A DOM &lt;template> element that contains a &lt;case> element.
        @params [LinkerPresets] presets
        @params [Case] parent
        @params [DOM]  WORKING_DOM
    */
    constructor(element, presets, parent = null, WORKING_DOM) {
        super();

        if (!element) {
            console.warn("No element has been supplied to this Case constructor!");
            return;
        }

        this.named_components = {};
        this.data = {};
        this.template = null;
        this.element = element;
        this.components = [];
        this.prop = null;
        this.url = null;
        this.parent_view = null;
        this.receiver = null;
        this.query = {};
        this.TEMPLATE_HANDLER = false;
        this.REQUESTING = false;
        this.cl = presets;
        this.exports = null;
        this.parent = parent;

        var return_object = this;

        ImportDataFromDataSet(this.data, element.dataset)

        if (element.nodeName == "TEMPLATE") {
            this.element = document.importNode(element.content, true).children[0];
            ImportDataFromDataSet(this.data, this.element.dataset);
        }

        for (let prop in this.data) {
            if (this.data[prop] == "" || !this.data[prop]) {
                this.data[prop] = parent.data[prop];
            }
        }

        if (this.element.tagName == "CASE") {

            var children = this.element.children;

            if (this.data.url)
                this.url = this.data.url;


            if (this.data.prop)
                this.prop = this.data.prop;

            if (this.data.export)
                this.exports = this.data.export;

            if (this.data.model) {
                if (presets.models[this.data.model])
                    presets.models[this.data.model].addView(this);
            } else if (this.data.schema &amp;&amp; presets.schemas[this.data.schema]) {

                var model = new presets.schemas[this.data.schema]();

                this.parent_view = new CaseParentView(this);

                model.addView(this);

                if (this.url) {
                    this.receiver = new Getter(this.url);
                    this.receiver.setModel(model);
                    this.request();
                }


                //return_object = this.parent_view;
            }

            for (var i = 0; i &lt; children.length; i++) {
                var child = children[i];

                var component = ComponentConstructor(this, child, presets, this.named_components, this, WORKING_DOM);

                if (component)
                    this.components = this.components.concat(component);
            }

            this.setModel(this.model);

            return return_object;
        } else {
            console.warn(`Case may only be constructed out of &lt;case>&lt;/case> elements. Received a ${element} in the case constructor!`)
            return undefined;
        }
    }

    destructor() {
        this.parent = null;

        for (var i = 0; i &lt; this.components.length; i++) {
            this.components[i].destructor();
        }

        this.components = null;

        if (this.element.parentElement)
            this.element.parentElement.removeChild(this.element);

        this.element = null;

        if (this.receiver)
            this.receiver.destructor();
    }

    request() {
        if (this.REQUESTING) return;
        this.receiver.get(this.query).then(() => {
            this.REQUESTING = false;
        });
        this.REQUESTING = true;
    }

    updateFromParent(data) {
        for (var i = 0; i &lt; this.components.length; i++) {
            let comp = this.components[i];
            if (comp instanceof Case) {
                comp.updateFromParent(data);
            } else {
                if (comp.import_prop &amp;&amp; data[comp.import_prop]) {
                    comp.update(data);
                }
            }
        }
    }

    update(data) {
        this.updateDimensions();

        for (var i = 0; i &lt; this.components.length; i++) {
            let comp = this.components[i];
            if (comp instanceof Case)
                comp.updateFromParent(data);
            else
                this.components[i].update(data);
        }

        if (this.TEMPLATE_HANDLER &amp;&amp; this.template) {
            this.REQUESTING = false;
            //components for each data element

            var result = data[this.prop].get();


            //We should establish filtering mechanisms here to remove unneeded data.

            //Need to isolate new results from existing, and cull existing that do not match results.
            a:
                for (var i = 0; i &lt; result.length; i++) {
                    //check for existing matches
                    for (var j = 0; j &lt; this.components.length; j++) {

                        var component = this.components[j];

                        if (component instanceof Case)
                            if (component.model &amp;&amp; component.model.identifier == result[i].identifier())
                                continue a;

                    }

                    var temp_ele = document.importNode(this.template.content, true).children[0];

                    var d = new Case(temp_ele, this.cl, this);

                    result[i].addView(d);

                    this.element.appendChild(temp_ele);

                    this.components.push(d);
                }
        }
    }

    setModel(model) {

        if (this.prop &amp;&amp; (model.schema[this.prop] instanceof Array)) {
            //This case will create sub templates from from each entry in the data array
            this.TEMPLATE_HANDLER = true;

            return;
        }

        if (this.prop &amp;&amp; model.schema[this.prop] &amp;&amp; model.schema[this.prop].prototype instanceof Model) {
            model = model.data[this.prop];
        }

        for (var i = 0; i &lt; this.components.length; i++){
            this.components[i].setModel(model);
        }


        super.setModel(model);
    }

    updateDimensions() {
        for (var i = 0; i &lt; this.components.length; i++) {
            this.components[i].updateDimensions();
        }
    }

    close(named_components) {}

    hide() {
        this.close(this.named_components);
        this.display = this.element.style.display;
        this.element.style.display = "none";
    }

    show() {
        if (this.element.style.display == "none") {
            this.element.style.display = this.display;
        }
    }

    export (t = {}) {

        if (this.exports &amp;&amp; this.model) {
            t[this.exports] = this.model.get()[this.exports];
        }

        if (this.parent)
            this.parent.import(t);
    }

    import (data) {

        if (this.model)
            this.model.add(data);

        this.export(data);
    }
}

function ComponentConstructor(parent, element, presets, named_list, parentCase, WORKING_DOM) {
    //Will only construct if there is a matching widget to handle the element

    var component = [];
    var cassettes = presets.cassettes;

    var class_ = element.dataset.class;
    var tag = element.tagName;

    if (element.dataset.name) {
        named_list[element.dataset.name] = element;
    }

    //Case of a Sub Case, hehe
    if (tag == "CASE") {
        var constructor = (class_ &amp;&amp; cassettes[class_]) ?
            cassettes[class_] : Case;
        return [new constructor(element, presets, parentCase, WORKING_DOM)];
    }

    //Case of a template
    if (tag == "TEMPLATE") {
        //If the template is empty, Check the working DOM for another TEMPLATE element whose ID matches this elements first class name
        if (element.innerHTML == "") {
            let ele;

            if (ele = WORKING_DOM.getElementById(element.classList[0])) {
                ele = ele.cloneNode(true);

                for (let prop in element.dataset)
                    ele.dataset[prop] = element.dataset[prop];

                var c = new Case(ele, presets, parentCase, WORKING_DOM);
                //Import the element into the DOM tree, replacing the existing TEMPLATE element.
                var p = element.parentElement;

                p.replaceChild(c.element, element);

                return [c];
            }

        }

        if (!parent.template) parent.template = element;

        return [];
    }

    //Case of input, if parent is form
    if (tag == "INPUT" &amp;&amp; element.dataset.prop) {
        if (cassettes.input || PresetCassettes.input) {
            component = [new(cassettes.input || PresetCassettes.input)(parentCase, element)];
        } else {
            console.warn("Missing input constructor in presets, unable to process form data!");
        }
    }

    //Case of form, the special case of Component
    if (tag == "FORM") {
        if (cassettes.form || PresetCassettes.form) {
            component = [new(cassettes.form || PresetCassettes.form)(parentCase, element)];
        } else {
            console.warn("Missing form constructor in presets, unable to process form data!");
        }
    }

    //Case of Component
    if (class_ &amp;&amp; (cassettes[class_] || PresetCassettes[class_])) {
        component = [new(cassettes[class_] || PresetCassettes[class_])(parentCase, element)];
    }
    //Continue parsing through the DOM tree.

    var children = element.children;

    for (var i = 0; i &lt; children.length; i++) {

        var c_components = ComponentConstructor(component[0] || parent, children[i], presets, named_list, parentCase, WORKING_DOM);

        if (component) {
            component = component.concat(c_components);
        }
    }

    return component;
}

export {
    Case,
    Cassette
}
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Case.html">Case</a></li><li><a href="CaseComponent.html">CaseComponent</a></li><li><a href="Component.html">Component</a></li><li><a href="Element.html">Element</a></li><li><a href="FailedComponent.html">FailedComponent</a></li><li><a href="Getter.html">Getter</a></li><li><a href="Linker_.html">Linker</a></li><li><a href="Modal.html">Modal</a></li><li><a href="ModelContainer.html">ModelContainer</a></li><li><a href="Setter.html">Setter</a></li><li><a href="Value.html">Value</a></li></ul><h3>Namespaces</h3><ul><li><a href="linker.html">linker</a></li></ul><h3>Global</h3><ul><li><a href="global.html#Lex">Lex</a></li><li><a href="global.html#light">light</a></li><li><a href="global.html#QueryStringToQueryMap">QueryStringToQueryMap</a></li><li><a href="global.html#setLinks">setLinks</a></li><li><a href="global.html#TransformTo">TransformTo</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Mon Jun 04 2018 19:21:37 GMT-0600 (Mountain Daylight Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
